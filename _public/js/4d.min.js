var messenger={init:function(){$.extend($.gritter.options,{fade_out_speed:100});$("#message_queue div.message").each(function(){class_name=null;if($(this).hasClass("error")){class_name="error"}if($(this).hasClass("notify")){class_name="notify"}if($(this).hasClass("success")){class_name="success"}$.gritter.add({title:$(this).attr("title")!=""?$(this).attr("title"):" ",text:$(this).html(),class_name:class_name})})}};var uidebug={string:"",capturing:false,init:function(){$(document).keyup(function(a){if(a.keyCode==192){if(uidebug.capturing){$("div#debug_info").hide();uidebug.capturing=false;uidebug.string=""}else{uidebug.capturing=true;uidebug.string=""}}if(uidebug.capturing){uidebug.string+=a.keyCode;if(uidebug.string=="192161718"){$("div#debug_info").show();uidebug.string=""}if(uidebug.string.length>9){uidebug.capturing=false;uidebug.string=""}return false}})}};var logger=function(a){if(typeof(console)!="undefined"&&console.log){console.log(a)}};var format={file:function(a){return"ABCDEFGH".charAt(a)},rank:function(a){return Math.abs(a-8)},fuzzytime:function(d){var b=new Date((d||"").replace(/-/g,"/").replace(/[TZ]/g," "));var c=(((new Date()).getTime()-b.getTime())/1000);var a=Math.floor(c/86400);if(isNaN(a)||a<0){return d}return a==0&&(c<60&&"just now"||c<120&&"about 1 minute ago"||c<3600&&"about "+Math.floor(c/60)+" minutes ago"||c<7200&&"about 1 hour ago"||c<86400&&"about "+Math.floor(c/3600)+" hours ago")||a==1&&"Yesterday"||a<7&&a+" days ago"||a>=7&&a<=10&&" last week"||a>=11&&a<=13&&" nearly 2 weeks ago"||a<31&&Math.ceil(a/7)+" weeks ago"||a<40&&"about 1 month ago"||a>=40&&Math.floor(a/30)+" months ago"},localtime:function(a){return a}};var move={selectedPromotionPiece:null,promotionSelection:null,piece:null,src:null,dst:null,confirmation:null,tmp_game:null,move_count:0,confirmationAdditionalText:"",selectPromotionPiece:function(){move.promotionSelection=$.gritter.add({sticky:true,title:"Promotion Selection for "+$(move.piece).attr("title")+" at "+$(move.dst).attr("title"),text:'Select a promotion piece:<br /><div class="modal-input"><input type="button" id="confirm_Q" value="Queen me, please!" /> <input type="button" id="confirm_N" value="Let me get a Knight!" /></div>',class_name:"notify"});$("input#confirm_Q").click(function(){move.selectedPromotionPiece="7";move.confirmationAdditionalText+="<br />That piece is eligible for promotion. You've chosen to promote to a Queen.";move.removePromotionSelection();move.confirmMove()});$("input#confirm_N").click(function(){move.selectedPromotionPiece="2";move.confirmationAdditionalText+="<br />That piece is eligible for promotion. You've chosen to promote to a Knight.";move.removePromotionSelection();move.confirmMove()})},removePromotionSelection:function(){if(move.promotionSelection!=null){$.gritter.remove(move.promotionSelection)}},confirmMove:function(){src=$(move.src).attr("id").replace("square_","");dst=$(move.dst).attr("id").replace("square_","");move.removeConfirmation();move.confirmation=$.gritter.add({sticky:true,title:"Confirm Move: "+$(move.piece).attr("title")+" from "+$(move.src).attr("title")+" to "+$(move.dst).attr("title"),text:"Would you like to move your "+$(move.piece).attr("title")+" from "+$(move.src).attr("title")+" to "+$(move.dst).attr("title")+"? "+move.confirmationAdditionalText+'<br />You may continue moving pieces and accept or decline this whenever you are ready.<div class="modal-input"><input type="button" id="confirm_y" value="Yes, Move." /> <input type="button" id="confirm_n" value="No, I don\'t like this move" /></div>',class_name:"notify"});$("input#confirm_y").click(function(){move.makeMove(src,dst,move.selectedPromotionPiece);move.removeConfirmation()});$("input#confirm_n").click(function(){move.clear();game.resetPositions();move.removeConfirmation()})},removeConfirmation:function(){if(move.confirmation!=null){$.gritter.remove(move.confirmation)}},clear:function(){move.src=null;move.dst=null;move.piece=null;move.move_count=0;move.tmp_game=null},tryMove:function(){move.selectedPromotionPiece=null;move.confirmationAdditionalText="";src=$(move.src).attr("id").replace("square_","");dst=$(move.dst).attr("id").replace("square_","");if(src==dst){return}if($(move.dst).children("div.piece").length>0){if($(move.src).children("div.piece").hasClass("color_1")&&$(move.dst).children("div.piece").hasClass("color_1")){$.gritter.add({title:"Invalid Move",class_name:"error",text:"You can't attack your own piece!"});game.resetPositions();return}else{if($(move.src).children("div.piece").hasClass("color_0")&&$(move.dst).children("div.piece").hasClass("color_0")){$.gritter.add({title:"Invalid Move",class_name:"error",text:"You can't attack your own piece!"});game.resetPositions();return}}}promotion=false;if($(move.src).children("div.piece").hasClass("piece_type_1")&&dst>=112){promotion=true;move.selectPromotionPiece()}if($(move.src).children("div.piece").hasClass("piece_type_-1")&&dst<=7){promotion=true;move.selectPromotionPiece()}if(!promotion){if(move.move_count==0){if(user.confirmBeforeMove){move.confirmMove()}else{move.makeMove(src,dst,move.selectedPromotionPiece);return}}}if(move.tmp_game==null){move.tmp_game=jQuery.extend(true,{},game)}if(typeof(move.tmp_game.pieces[move.tmp_game.board[dst]])!="undefined"){move.tmp_game.pieces[move.tmp_game.board[dst]].position=game.TRASH}move.tmp_game.board[dst]=move.tmp_game.board[src];move.tmp_game.pieces[move.tmp_game.board[src]].position=dst;move.move_count++;game.placePieces(move.tmp_game.pieces);$("div.piece").unbind("click")},makeMove:function(b,c,a){jQuery.getJSON("/game/makeMove/"+game.board[game.GAME_ID]+"/"+b+"/"+c+(a?"/"+a:""),function(d){if(d.message_type=="error"){game.resetPositions()}$.gritter.add({title:d.message_title,class_name:d.message_type,text:d.message_text});move.clear();getObject.game(game.board[game.GAME_ID]);updatedGames.restartTimer()})}};var square={size:50,id:0,cssclass:"square",bordersize:1,coordinates:Array(0,0),$container:null,color:0,title:"",contents:"",markAsSource:function(b,a){$("div.selected_src").removeClass("selected_src");$(a.helper).parent().addClass("selected_src");move.src=$(a.helper).parent();move.piece=$(a.helper)},markAsDestination:function(b,a){if($(move.src).attr("id")==$(this).attr("id")){$(this).removeClass("selected_src");move.src=null;move.piece=null;return}$("div.selected_dst").removeClass("selected_dst");$(this).addClass("selected_dst");$(this).children("div.piece").not(move.piece).hide();move.dst=$(this);move.tryMove();game.renderInfo();$("div.square").removeClass("validDestination")},getSquareSizeArray:function(){return Array((square.size+square.bordersize),(square.size+square.bordersize))},renderSquare:function(){}};var user={renderUserInfo:function(){if(!user.id){return}$("#userinfo #username").text(user.username);$("#userinfo #email").text(user.email);$("#userinfo #notifications").text((user.notifications?"ON":"OFF"));$("#userinfo #wins").text(user.wins);$("#userinfo #losses").text(user.losses);$("#userinfo #draws").text(user.draws)}};var piece={PAWN:1,KNIGHT:2,KING:3,BISHOP:5,ROOK:6,QUEEN:7,WHITE_PAWN:1,BLACK_PAWN:-1,WHITE_KNIGHT:2,BLACK_KNIGHT:-2,WHITE_KING:3,BLACK_KING:-3,WHITE_BISHOP:5,BLACK_BISHOP:-5,WHITE_ROOK:6,BLACK_ROOK:-6,WHITE_QUEEN:7,BLACK_QUEEN:-7,piece:0,position:0,color:0,cssclass:"piece",$container:null,init:function(){piece=0;position=0;color=0;cssclass="piece";$container=null},getScore:function(a){if(!a){return 0}var b=Math.abs(a);if(b==piece.PAWN){return 1}else{if(b==piece.KNIGHT){return 3}else{if(b==piece.BISHOP){return 3.1}else{if(b==piece.ROOK){return 5}else{if(b==piece.QUEEN){return 9}else{return 0}}}}}},renderPiece:function(){piece.cssclass="piece";piece.color=0;if(piece.piece>0){piece.color=1}if((piece.piece==-3&&game.board[game.BLACK_IN_CHECK])||(piece.piece==3&&game.board[game.WHITE_IN_CHECK])){piece.cssclass+=" check"}piece.$container=jQuery('<div id="piece_'+piece.position+'" class="draggable '+piece.cssclass+" piece_type_"+piece.piece+" color_"+piece.color+'" title="'+piece.pieceName()+'"><span class="piece_type" title="'+piece.piece+'">'+piece.pieceUnicode()+"</span></div>");piece.$container.css({height:"100%",width:"100%"});if(game.board[game.STATE_INDEX]==0){piece.$container.click(function(){$("div.square").removeClass("validDestination").removeClass("validCapture").removeClass("validEnPassant").removeClass("validCastle");validMoves.squares={};getObject.validMoves(game.board[game.GAME_ID],$(this).attr("id").replace("piece_",""))})}piece.$container.mouseout(function(){$("div.square").removeClass("validDestination").removeClass("validCapture").removeClass("validEnPassant").removeClass("validCastle")});gridArray=square.getSquareSizeArray();return piece.$container},pieceUnicode:function(){if(!piece.piece){return}var a=piece.piece;if(a==piece.WHITE_PAWN){return"&#9817;"}else{if(a==piece.BLACK_PAWN){return"&#9823;"}else{if(a==piece.WHITE_KNIGHT){return"&#9816;"}else{if(a==piece.BLACK_KNIGHT){return"&#9822;"}else{if(a==piece.WHITE_KING){return"&#9812;"}else{if(a==piece.BLACK_KING){return"&#9818;"}else{if(a==piece.WHITE_BISHOP){return"&#9815;"}else{if(a==piece.BLACK_BISHOP){return"&#9821;"}else{if(a==piece.WHITE_ROOK){return"&#9814;"}else{if(a==piece.BLACK_ROOK){return"&#9820;"}else{if(a==piece.WHITE_QUEEN){return"&#9813;"}else{if(a==piece.BLACK_QUEEN){return"&#9819;"}else{return piece.piece}}}}}}}}}}}}},pieceName:function(){if(!piece.piece){return}var a=Math.abs(piece.piece);if(a==piece.PAWN){return"Pawn"}else{if(a==piece.KNIGHT){return"Knight"}else{if(a==piece.KING){return"King"}else{if(a==piece.BISHOP){return"Bishop"}else{if(a==piece.ROOK){return"Rook"}else{if(a==piece.QUEEN){return"Queen"}else{return piece.piece}}}}}}}};var validMoves={squares:{moves:{},captures:{},enpassant:{},castles:{}},init:function(){squares={moves:{},captures:{},enpassant:{},castles:{}}},mark:function(){for(i=0;typeof(validMoves.squares.moves[i])!="undefined";i++){$("#square_"+validMoves.squares.moves[i]).addClass("validDestination")}for(i=0;typeof(validMoves.squares.captures[i])!="undefined";i++){$("#square_"+validMoves.squares.captures[i]).addClass("validCapture")}for(i=0;typeof(validMoves.squares.enpassant[i])!="undefined";i++){$("#square_"+validMoves.squares.enpassant[i]).addClass("validEnPassant")}for(i=0;typeof(validMoves.squares.castles[i])!="undefined";i++){$("#square_"+validMoves.squares.castles[i]).addClass("validCastle")}}};var game={LAST_MOVE:110,TURN:94,WHITE_PLAYER_ID:78,BLACK_PLAYER_ID:62,WHITE_PLAYER_NAME:46,BLACK_PLAYER_NAME:30,W_CASTLE_K:109,W_CASTLE_Q:93,B_CASTLE_K:77,B_CASTLE_Q:61,FIFTY_MOVE_DRAW:45,TIME_OF_LAST_MOVE:29,W_EN_PASSANT:108,B_EN_PASSANT:92,GAME_NAME:76,GAME_ID:60,GAME_FINISHED:44,PLY:28,STATE_INDEX:107,NUM_STATES:91,LAST_MOVE_SRC:75,LAST_MOVE_DST:59,WHITE_IN_CHECK:43,BLACK_IN_CHECK:27,PENDING_DRAW:106,TRASH:105,boardsize:0,square_count:8,bordersize:1,$boardcontainer:null,move_src:null,move_dst:null,move_piece:null,include_coordinates:true,whitePieces:Array(),blackPieces:Array(),flip:false,init:function(){game.$boardcontainer=null;game.flip=false;game.whitePieces=Array();game.blackPieces=Array();game.pieces=null;game.move_src=null;game.move_dst=null;game.move_piece=null;game.whiteScore=0;game.blackScore=0},renderBoard:function(){$("div#game_board").attr("id","game_board_"+game.board[game.GAME_ID]);$("div.square.lastmove_src").removeClass("lastmove_src");$("div.square.lastmove_dst").removeClass("lastmove_dst");$("div.game_board div.board").removeClass("flip");if(view.user==game.board[game.BLACK_PLAYER_ID]&&(game.board[game.BLACK_PLAYER_ID]!=game.board[game.WHITE_PLAYER_ID]||game.board[game.TURN]==0)){game.flip=true}if(game.flip){$("div.game_board div.board").removeClass("regular").addClass("flipped")}else{$("div.game_board div.board").removeClass("flipped").addClass("regular")}$("div#square_"+game.board[game.LAST_MOVE_SRC]).addClass("lastmove_src");$("div#square_"+game.board[game.LAST_MOVE_DST]).addClass("lastmove_dst");$("div.square").each(function(){$(this).droppable({drop:square.markAsDestination})})},renderLink:function(){var b=game.board[game.GAME_NAME];var a=game.board[game.GAME_ID];$("#navigation ul li a#game_link_"+a).remove();$("#navigation ul li.info").before('<li><a class="gamelink" href="/game/view/'+a+'" id="game_link_'+a+'">Game <span>'+b+"</span></a></li>")},placePieces:function(a){game.blackPieces=Array();game.whitePieces=Array();a=(!a?game.pieces:a);$("#pieceScore").remove();$("div.piece").remove();for(x=0;x<a.length;x++){this_piece=a[x];if(this_piece.piece<0){game.blackPieces.push(this_piece);game.blackScore+=(+piece.getScore(this_piece.piece))}else{if(this_piece.piece>0){game.whitePieces.push(this_piece);game.whiteScore+=(+piece.getScore(this_piece.piece))}}piece.position=this_piece.position;piece.piece=this_piece.piece;$piece=piece.renderPiece();$("#square_"+piece.position).append($piece);if(game.board[game.STATE_INDEX]==0){if(move.move_count>0){game.setAllPiecesDraggable()}else{if(game.board[game.TURN]==1&&view.user==game.board[game.WHITE_PLAYER_ID]){game.setWhitePiecesDraggable()}else{if(game.board[game.TURN]==0&&view.user==game.board[game.BLACK_PLAYER_ID]){game.setBlackPiecesDraggable()}}}}}$("div#footer").append(' <span id="pieceScore">('+game.whiteScore.toFixed(1)+"/"+game.blackScore.toFixed(1)+")</span>")},setAllPiecesDraggable:function(){game.setWhitePiecesDraggable();game.setBlackPiecesDraggable()},setWhitePiecesDraggable:function(){$("div.piece.color_1").draggable({containment:$("div.board"),zIndex:"9999",grid:gridArray,start:square.markAsSource})},setBlackPiecesDraggable:function(){$("div.piece.color_0").draggable({containment:$("div.board"),zIndex:"9999",grid:gridArray,start:square.markAsSource})},disableDraggable:function(){$("div.piece.draggable").draggable("disable")},enableDraggable:function(){$("div.piece.draggable").draggable("enable")},renderInfo:function(){var a=game.board[game.GAME_NAME];var b=game.board[game.GAME_ID];var d=game.board[game.LAST_MOVE];var h=game.board[game.TURN];var f=game.board[game.WHITE_PLAYER_NAME];var j=game.board[game.BLACK_PLAYER_NAME];var e=format.localtime(game.board[game.TIME_OF_LAST_MOVE]);var g=game.board[game.PENDING_DRAW];var c=game.board[game.STATE_INDEX];var k=game.board[game.NUM_STATES];$("div#game_info").css({marginLeft:$("div#game_board_"+b).css("width"),marginTop:(square.size/2)+"px"});$("div#game_info").css({marginRight:"42px"});$("#game_name").html('<span class="gameName">'+a+'</span> <span class="gamePlayers">'+f+" vs "+j+'</span> <span class="gamePlys">(showing ply: '+(k-c)+"/"+k+")</span>");$("#game_statenav").html((c<k?'<a href="/game/view/'+b+"/"+((+c)+1)+'" class="mimicbutton" id="stateBack">&larr; Previous Ply</a> ':"")+(c>0?' <a href="/game/view/'+b+"/"+((+c)+1)+'" class="mimicbutton" id="stateForward">Next Ply &rarr;</a>':""));if(c>=k&&c<=0){$("#game_statenav").hide()}$("#game_lastmove").html((d?'Last move was <span class="lastMove">'+d+'</span> &mdash; <span class="timeOfLastMove fuzzy" title="'+e+'">'+format.fuzzytime(e)+"</span>":"No moves have been made"));$("#game_turn").addClass("turn_"+h).html('It is <span class="playersTurn">'+(h?""+f+"'s Turn":""+j+"'s Turn")+"</span>");$("a#stateBack").click(function(){getObject.game(game.board[game.GAME_ID],(+game.board[game.STATE_INDEX])+1);return false});$("a#stateForward").click(function(){getObject.game(game.board[game.GAME_ID],(+game.board[game.STATE_INDEX])-1);return false});if(g){accept_draw_request=$.gritter.add({sticky:true,title:'Accept Draw for Game "'+game.board[game.GAME_NAME]+'":',text:'Your opponent has offered a draw. <div class="modal-input"><input type="button" id="confirm_y" value="Accept Draw." /> <input type="button" id="confirm_n" value="Decline Draw" /></div>',class_name:"notify"});$("input#confirm_y").click(function(){UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/acceptDraw/"+game.board[game.GAME_ID],function(l){$.gritter.add({title:l.message_title,class_name:l.message_type,text:l.message_text});UI.loading.hide($("#gameName span.gameName"));getObject.game(game.board[game.GAME_ID])});$.gritter.remove(accept_draw_request)});$("input#confirm_n").click(function(){UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/declineDraw/"+game.board[game.GAME_ID],function(l){$.gritter.add({title:l.message_title,class_name:l.message_type,text:l.message_text});UI.loading.hide($("#gameName span.gameName"));getObject.game(game.board[game.GAME_ID])});$.gritter.remove(accept_draw_request)});game.disableDraggable()}},resetPositions:function(){$("div.square.selected_src").removeClass("selected_src");$("div.square.selected_dst").removeClass("selected_dst");game.placePieces()}};var gameSummary={init:function(){},render:function(){var d=false;var b=false;var a=gameSummary.board[game.GAME_ID];if($("#game_row_"+a).length>0){if(gameSummary.board[game.GAME_FINISHED]){$("#game_row_"+a).remove();return}$game_row=$("#game_row_"+a);d=true}else{if(gameSummary.board[game.GAME_FINISHED]){return}$game_row=jQuery('<tr title="click to play this game ('+a+')" class="game_row" id="game_row_'+a+'"></tr>')}$game_row.html("");$game_row.removeClass("attention");var c=format.localtime(gameSummary.board[game.TIME_OF_LAST_MOVE]);b=(((gameSummary.board[game.TURN]==1&&view.user==gameSummary.board[game.WHITE_PLAYER_ID])||(gameSummary.board[game.TURN]==0&&view.user==gameSummary.board[game.BLACK_PLAYER_ID]))?true:false);if(b){$game_row.addClass("attention")}$game_row_data=jQuery('	<td class="game_row_name">'+gameSummary.board[game.GAME_NAME]+" ("+a+')</td>\n									<td class="game_row_players">'+gameSummary.board[game.WHITE_PLAYER_NAME]+" vs. "+gameSummary.board[game.BLACK_PLAYER_NAME]+(b?'<br /><span class="attention">it\'s your turn!</span>':"")+'</td>\n									<td class="game_row_lastmove">'+gameSummary.board[game.LAST_MOVE]+' - <span class="timeOfLastMove fuzzy" title="'+c+'">'+format.fuzzytime(c)+"</span></td>");$game_row.append($game_row_data);$game_row.children("td").bind("click",function(){target_game=$(this).parent("tr").attr("id").replace("game_row_","");window.location.href="/game/view/"+target_game;return false});if(!d){$("#user_games_summary tbody").append($game_row)}gameSummary.sort()},sort:function(){var a=[];$("#user_games_body tr").each(function(){tr_a=$(this);ts_a=$(tr_a).children("td.game_row_lastmove").children("span.timeOfLastMove").attr("title");tr_a_id=$(tr_a).attr("ID");a.push(ts_a)});a.sort();for(var c=0,b=a.length;c<b;c++){$("#user_games_body tr").each(function(){tr_a=$(this);ts_a=$(tr_a).children("td.game_row_lastmove").children("span.timeOfLastMove").attr("title");tr_a_id=$(tr_a).attr("ID");if(ts_a==a[c]){a[c]=tr_a_id;$(tr_a).clone(true).prependTo("#user_games_body");$(tr_a).remove()}})}},sortCompare:function(d,c){if(d<c){return false}return true}};var updatedGames={timer:null,running:false,delay:31000,collection:null,reloadConfirmation:null,init:function(){},markForUpdate:function(){if(!updatedGames.collection){return}for(x=0;x<updatedGames.collection.length;x++){var a=false;jQuery.extend(true,gameSummary,updatedGames.collection[x]);if($("#game_row_"+gameSummary.board[game.GAME_ID]).length>0){gameSummary.render();UI.markRow($("#game_row_"+gameSummary.board[game.GAME_ID]));a=true}if($("#game_link_"+gameSummary.board[game.GAME_ID]).length>0){UI.markLink($("#game_link_"+gameSummary.board[game.GAME_ID]));a=true}if($("#game_board_"+gameSummary.board[game.GAME_ID]).length>0&&updatedGames.reloadConfirmation==null){updatedGames.reloadConfirmation=$.gritter.add({sticky:true,title:"Activity in Game: "+gameSummary.board[game.GAME_NAME]+" ("+gameSummary.board[game.LAST_MOVE]+" - "+format.fuzzytime(gameSummary.board[game.TIME_OF_LAST_MOVE])+")",text:'Would you like to reload this game?<div class="modal-input"><input type="button" id="confirm_y" value="Yes, Reload." /> <input type="button" id="confirm_n" value="No, I\'m kind of busy right now" /></div>',class_name:"notify"});$("input#confirm_y").click(function(){move.clear();getObject.game(gameSummary.board[game.GAME_ID]);$.gritter.remove(updatedGames.reloadConfirmation)});$("input#confirm_n").click(function(){$.gritter.remove(updatedGames.reloadConfirmation)});a=true}if(a){continue}strTurn=(gameSummary.board[game.TURN]==1?"White":"Black");strYourTurn="";if((gameSummary.board[game.TURN]==1&&gameSummary.board[game.WHITE_PLAYER_ID]==view.user)||(gameSummary.board[game.TURN]==0&&gameSummary.board[game.BLACK_BLAYER_ID]==view.user)){strYourTurn=" (hey, that's you!) "}$.gritter.add({sticky:false,title:'Activity in Game: <a href="/game/view/'+gameSummary.board[game.GAME_ID]+'">'+gameSummary.board[game.GAME_NAME]+"</a>",text:'The last move was "'+gameSummary.board[game.LAST_MOVE]+'". It is '+strTurn+"'s"+strYourTurn+" turn.",class_name:"notify"})}},startTimer:function(){updatedGames.timer=setInterval(updatedGames.intervalAction,updatedGames.delay);updatedGames.running=true},showTimerControl:function(){$("input#timerFrob").remove();$("div#footer").append('<input type="button" id="timerFrob" value="timer running. click to stop" />');$("input#timerFrob").click(function(){if(updatedGames.running==true){updatedGames.stopTimer();$("input#timerFrob").val("timer stopped. click to start")}else{updatedGames.startTimer();$("input#timerFrob").val("timer running. click to stop")}})},stopTimer:function(){clearInterval(updatedGames.timer);updatedGames.running=false},restartTimer:function(){updatedGames.stopTimer();updatedGames.startTimer()},intervalAction:function(){getObject.isLoggedIn();getObject.updatedGames((updatedGames.delay/1000)-1);getObject.unreadMessages();UI.updateFuzzyTimes()}};var userList={list:null,renderOpponentSelection:function(){if(!userList.list){return}for(x=0;x<userList.list.length;x++){if(userList.list[x].id>=1000){$("select#opponent").append('<option value="'+userList.list[x].id+'">'+userList.list[x].username+"</option>")}}},getUserName:function(a){for(x=0;x<userList.list.length;x++){if(userList.list[x].id==a){return userList.list[x].username}}return"unknown user"}};var gameNames={list:{},init:function(){jQuery.getJSON("/game/gameNames/",function(a){if(a){gameNames.list=a.list}$("#form_creategame input#name").blur(function(){gameNames.checkGameName()})})},checkGameName:function(){for(x=0;x<gameNames.list.length;x++){if($("#form_creategame input#name").val()==gameNames.list[x]){$("#isNameAvailable").text("This name is already taken");$("#form_creategame input#name").removeClass("valid").addClass("invalid");return}else{$("#isNameAvailable").text("");$("#form_creategame input#name").removeClass("invalid").addClass("valid")}}}};var messages={messages:null,gritter_messages:Array(),notify:function(){if(messages.messages.length>0){if($("#navigation ul a#message_link").length<=0){$("#navigation ul").append('<li><a class="messagelink" href="/dashboard/" id="message_link">New Messages <span><strong class="message_count">0</strong> unread</span></a></li>');$("#navigation ul a#message_link").click(function(){for(x=0;x<messages.gritter_messages.length;x++){$.gritter.remove(messages.gritter_messages[x])}messages.display();return false})}$("#navigation ul a#message_link strong.message_count").text(messages.messages.length);UI.markLink($("#navigation ul a#message_link"))}else{$("#navigation ul a#message_link").remove()}},display:function(){for(i=0;i<messages.messages.length;i++){timesent=format.localtime(messages.messages[i].time);gritter_message=$.gritter.add({sticky:true,title:"("+messages.messages[i].id+") "+messages.messages[i].subject,text:"Message from "+userList.getUserName(messages.messages[i].from_user_id)+' (sent <span class="timeStamp fuzzy" title="'+timesent+'">'+format.fuzzytime(timesent)+"</span>)<br />"+messages.messages[i].text,gritter_item_title:messages.messages[i].id,class_name:"notify message",before_close:function(a){var c=a.find("span.gritter-title").text();var b=c.substring(1,5);messages.markAsRead(b);getObject.unreadMessages()}});messages.gritter_messages.push(gritter_message);if(i==4&&messages.messages.length>5){$.gritter.add({sticky:false,title:"Message Display Limit.",text:"There are "+messages.messages.length+" unread messages. Only 5 unread messages will be displayed at a time.",class_name:"error"});break}}},markAsRead:function(a){if(typeof(a)=="undefined"){return}jQuery.getJSON("/user/markMessageRead/"+a,function(b){if(!b){return}if(b.message_type=="error"){$.gritter.add({title:b.message_title,class_name:b.message_type,text:b.message_text})}})}};var gameHistory={history:null,render:function(){$("#game_history_container").html("").hide();last_history=0;for(i=0;i<gameHistory.history.length;i++){if(last_history!=gameHistory.history[i].turn){$("#game_history_container").append(" <strong>"+gameHistory.history[i].turn+".</strong>&nbsp;");last_history=gameHistory.history[i].turn}else{$("#game_history_container").append("&nbsp;")}$("#game_history_container").append(gameHistory.history[i].move+"")}$("#game_history_container").show()}};var getObject={isLoggedIn:function(){jQuery.getJSON("/user/isLoggedIn/",function(a){if(a!=1){$.gritter.add({title:"Not Logged In",class_name:"error",text:"Uh-oh! You\re not logged in. Please log in!"});return}})},user:function(){jQuery.getJSON("/user/getUser/",function(a){jQuery.extend(true,user,a);user.renderUserInfo();if(!a.current_games){return}for(x=0;x<a.current_games.length;x++){getObject.gameSummary(a.current_games[x])}})},unreadMessages:function(){jQuery.getJSON("/user/getUnreadMessages/",function(a){if(!a){return}messages.messages=null;jQuery.extend(true,messages,a);messages.notify()})},userList:function(){jQuery.getJSON("/user/getUserList/",function(a){if(!a){return}jQuery.extend(true,userList,a);userList.renderOpponentSelection()})},game:function(a,b){if(!a){return}b=(!b?0:b);UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/getGame/"+a+"/"+b,function(c){game.init();jQuery.extend(true,game,c);game.renderBoard();game.renderInfo();game.placePieces();game.renderLink();UI.loading.hide($("#gameName span.gameName"))})},gameSummary:function(a){if(!a){return}jQuery.getJSON("/game/getGameSummary/"+a,function(b){gameSummary.init();jQuery.extend(true,gameSummary,b);gameSummary.render()})},gameHistory:function(a){if(!a){return}UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/getHistory/"+a,function(b){gameHistory.history=null;jQuery.extend(true,gameHistory,b);gameHistory.render();UI.loading.hide($("#gameName span.gameName"))})},updatedGames:function(a){if(!a){return}UI.loading.show($("#user_games_header"));jQuery.getJSON("/game/getUpdatedGames/"+a,function(b){updatedGames.init();jQuery.extend(true,updatedGames,b);updatedGames.markForUpdate();UI.loading.hide($("#user_games_header"))})},validMoves:function(a,b){UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/getValidMoves/"+a+"/"+b,function(c){jQuery.extend(true,validMoves.squares,c.squares);validMoves.init();validMoves.mark();UI.loading.hide($("#gameName span.gameName"))})}};var view={user:null,game:null,init:function(){if(!$("body").hasClass("log_in")){getObject.isLoggedIn()}$.ajaxSetup({error:function(a,c,b){$.gritter.add({title:"API Error",class_name:"error",text:"There was a problem communicating with the API ("+c+"). I'll keep trying. With luck, it will resolve itself!"});return}});this.determineUser();this.determineGame();if(this.user){getObject.user();getObject.unreadMessages()}getObject.userList();if(this.game){getObject.game(this.game)}if($("body.dashboard").length>0){this.dashboard.init()}if($("body.game").length>0){this.game_view.init()}$("form#form_login #username").focus()},determineUser:function(){var a=$("#user_id").attr("title");if(a==""){a=null}this.user=a},determineGame:function(){var a=$("#game_id").attr("title");if(a==""){a=null}this.game=a},game_view:{init:function(){view.game_view.bindGameHistory();view.game_view.bindResign();view.game_view.bindOfferDraw();view.game_view.bindManualMoving()},bindGameHistory:function(){$("a#game_history").click(function(){if($(this).attr("title")=="Show Game History"){getObject.gameHistory(view.game);$(this).attr("title","Hide Game History").text("Hide this Game's History")}else{$("#game_history_container").hide();$(this).attr("title","Show Game History").text("View this Game's History")}return false})},bindManualMoving:function(){$("#submit-move").click(function(){$("div.selected_src").removeClass("selected_src");$("div.selected_dst").removeClass("selected_dst");var c=null;var d=null;var a=$("#game_manual_move input#src").val();var b=$("#game_manual_move input#dst").val();$("div.square").each(function(){if($(this).attr("title").toLowerCase()==a.toLowerCase()){c=$(this);$(this).addClass("selected_src")}if($(this).attr("title").toLowerCase()==b.toLowerCase()){d=$(this);$(this).addClass("selected_dst")}});if(c!==null&&d!==null){move.src=c;move.dst=d;move.tryMove();game.renderInfo();$("div.square").removeClass("validDestination")}else{$.gritter.add({title:"Invalid Move",class_name:"error",text:"I couldn't make heads nor tails of that input. Try again?"})}})},bindResign:function(){$("a#resign").click(function(){resign_confirmation=$.gritter.add({sticky:true,title:'Confirm Resignation from Game "'+game.board[game.GAME_NAME]+'":',text:'Are you absolutely, positively, SURE that you wish to resign from this game? <div class="modal-input"><input type="button" id="confirm_y" value="Yes, I suck." /> <input type="button" id="confirm_n" value="No! Eye of the Tiger!" /></div>',class_name:"notify"});$("input#confirm_y").click(function(){UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/resign/"+game.board[game.GAME_ID],function(a){$.gritter.add({title:a.message_title,class_name:a.message_type,text:a.message_text});UI.loading.hide($("#gameName span.gameName"));getObject.game(game.board[game.GAME_ID])});$.gritter.remove(resign_confirmation)});$("input#confirm_n").click(function(){$.gritter.remove(resign_confirmation)});return false})},bindOfferDraw:function(){$("a#offer_draw").click(function(){draw_offer=$.gritter.add({sticky:true,title:'Draw Offer for Game "'+game.board[game.GAME_NAME]+'":',text:'Are you sure you want to offer a draw to your opponent? <div class="modal-input"><input type="button" id="confirm_y" value="Yes, I\'ve had enough." /> <input type="button" id="confirm_n" value="No! Don\'t stop believin!" /></div>',class_name:"notify"});$("input#confirm_y").click(function(){UI.loading.show($("#gameName span.gameName"));jQuery.getJSON("/game/offerDraw/"+game.board[game.GAME_ID],function(a){$.gritter.add({title:a.message_title,class_name:a.message_type,text:a.message_text});UI.loading.hide($("#gameName span.gameName"));getObject.game(game.board[game.GAME_ID])});$.gritter.remove(draw_offer)});$("input#confirm_n").click(function(){$.gritter.remove(draw_offer)});return false})}},dashboard:{init:function(){$("#form_userinfo_email").hide();$("#form_userinfo_password").hide();$("#form_userinfo_notifications").hide();$("#edit_userinfo_email").show().click(function(){if($("#form_userinfo_email:hidden").length>0){$("#form_userinfo_email").show();$("#input_email").focus();$("#edit_userinfo_email").text("cancel change")}else{$("#form_userinfo_email").hide();$('#form_userinfo_email input[type="text"]').val("");$("#edit_userinfo_email").text("change")}return false});$("#edit_userinfo_password").show().click(function(){if($("#form_userinfo_password:hidden").length>0){$("#form_userinfo_password").show();$("#input_password").focus();$("#edit_userinfo_password").text("cancel change")}else{$("#form_userinfo_password").hide();$('#form_userinfo_password input[type="password"]').val("");$("#edit_userinfo_password").text("change")}return false});$("#edit_userinfo_notifications").show().click(function(){user.notifications=(user.notifications?0:1);jQuery.getJSON("/user/setNotifications/"+user.notifications,function(a){$.gritter.add({title:a.message_title,class_name:a.message_type,text:a.message_text});getObject.user(view.user)});return false});gameNames.init();view.dashboard.bindCreateGame();view.dashboard.bindSetPassword();view.dashboard.bindSetEmail()},bindSetEmail:function(){$("#email-submit").click(function(){jQuery.getJSON("/user/setEmail/"+$("#input_email").val(),function(a){$.gritter.add({title:a.message_title,class_name:a.message_type,text:a.message_text});getObject.user(view.user)});return false})},bindSetPassword:function(){$("#password-submit").click(function(){if($("#input_password").val()!=$("#input_password2").val()){$.gritter.add({title:"Password Do Not Match",class_name:"error",text:"Passwords must match! Please try again."});return}jQuery.getJSON("/user/setPassword/"+$("#input_password").val(),function(a){$.gritter.add({title:a.message_title,class_name:a.message_type,text:a.message_text});getObject.user(view.user)});return false})},bindCreateGame:function(){$("#form_creategame").submit(function(){var b=$("#form_creategame #name").val();var a=$("#form_creategame #opponent").val();var c=$("#form_creategame #playas").val();jQuery.getJSON("/game/createGame/"+b+"/"+a+"/"+c,function(d){$.gritter.add({title:d.message_title,class_name:d.message_type,text:d.message_text});getObject.gameSummary(d.object_id)});return false})}}};var UI={markLink:function(a){a.pulse({textColors:["#ccccbb","#111100"],runLength:10})},markRow:function(a,b){b=(typeof(b)=="undefined"?"this game has been updated":b);a.removeClass("attention").addClass("attention");a.children("td.game_row_lastmove").append('<br /><span class="attention">'+b+"</span>")},loading:{show:function(a){UI.loading.hide(a);a.append('<img class="smallloading" src="/_public/img/small_loading.gif" />')},hide:function(a){a.children("img.smallloading").remove()}},updateFuzzyTimes:function(){$("span.fuzzy").each(function(){if($(this).attr("title").length>0){$(this).html(format.fuzzytime($(this).attr("title")))}})}};$(document).ready(function(){messenger.init();uidebug.init();view.init();if(view.user){updatedGames.startTimer()}var a=function(){$.gritter.add({title:"Form Error",class_name:"error",text:"Please correct the invalid form values (outlined in red), then re-submit"})};validator=$.fn.t9validator;validator.setcallback(a);validator.bind($("form"));$(function(){$(window).scroll(function(){var b=$(window).scrollTop();if(b!=0){$("#navigation ul").stop().animate({opacity:"0.2"},400)}else{$("#navigation ul").stop().animate({opacity:"1"},400)}});$("#navigation ul").hover(function(c){var b=$(window).scrollTop();if(b!=0){$("#navigation ul").stop().animate({opacity:"1"},400)}},function(c){var b=$(window).scrollTop();if(b!=0){$("#navigation ul").stop().animate({opacity:"0.2"},400)}})})});